<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>6.調用StandardIndicatorSet裡的指標，用不註明symbol的方式，預設會使用yaml檔策略區塊底下的symbol</title>
  <link rel="stylesheet" href="https://stackedit.io/style.css" />
</head>

<body class="stackedit">
  <div class="stackedit__html"><h2 id="調用standardindicatorset裡的指標，用不註明symbol的方式，預設會使用yaml檔策略區塊底下的symbol">調用StandardIndicatorSet裡的指標，用不註明symbol的方式，預設會使用yaml檔策略區塊底下的symbol</h2>
<h3 id="在standardindicatorset的指標有：">在StandardIndicatorSet的指標有：</h3>
<pre><code>1. SMA 2. EWMA 3. VWMA 4. PivotHigh 5. PivotLow 6. ATR 7. ATRP 8. EMV 9. CCI 10. HULL 11. STOCH 12. BOLL 13. MACD 14. RSI 15. GHFilter 16. KalmanFilter
</code></pre>
<h3 id="幾個重點：">幾個重點：</h3>
<ol>
<li>
<p>用*indicator.來選擇指標，並宣告在策略檔的struct<br>
必須選擇有在StandardIndicatorSet裡的指標<br>
舉例(這裡以SMA為例)：</p>
<pre><code>type Strategy struct {
	......
	SMA *indicator.SMA
</code></pre>
</li>
<li>
<p>以*bbgo.StandardIndicatorSet類型宣告變數</p>
<pre><code>type Strategy struct {
	......
	SMA *indicator.SMA
	StandardIndicatorSet *bbgo.StandardIndicatorSet
</code></pre>
</li>
<li>
<p>確認目前yaml檔訂閱的K線資料為何<br>
我們的指標就會以這邊的s.Symbol來做指標的計算</p>
<pre><code>func (s *Strategy) Subscribe(session *bbgo.ExchangeSession) {
	session.Subscribe(types.KLineChannel, s.Symbol, types.SubscribeOptions{Interval: "5m"})
</code></pre>
<p>※注意，策略struct裡的這個Symbol變數不能改成別的名稱，會出問題</p>
<pre><code>Symbol string  `json:"symbol"`
</code></pre>
</li>
<li>
<p>在func (s *Strategy) Run(<br>
以剛剛宣告的StandardIndicatorSet來調用SMA方法，並指給剛剛在struct宣告的SMA變數<br>
且傳入interval與window參數<br>
這邊不註明symbol，但其實會以預設的s.Symbol的K線資料來計算指標</p>
<pre><code>s.SMA = s.StandardIndicatorSet.SMA(types.IntervalWindow{Interval: s.Interval, Window: s.Window})
</code></pre>
</li>
<li>
<p>直接使用OnUpdate()或Last(i)來取得指標值<br>
不用自己幫指標bind K線資料，StandardIndicatorSet已經幫我們處理掉這段</p>
<pre><code>在func (s *Strategy) Run(
	s.SMA = s.StandardIndicatorSet.SMA(types.IntervalWindow{Interval: s.Interval, Window: s.Window})
	s.SMA.OnUpdate(func(v float64) {

		fmt.Println("sma value from OnUpdate: ", v, " symbol:", s.StandardIndicatorSet.Symbol)
	})
</code></pre>
</li>
<li>
<p>在session.MarketDataStream.OnKLineClosed(</p>
<pre><code>fmt.Println("sma value with Last(0): ", s.SMA.Last(0))
</code></pre>
</li>
</ol>
<h3 id="完整策略檔程式碼">完整策略檔程式碼</h3>
<pre><code>package getIndStandard

import (
	"context"
	"fmt"

	"github.com/c9s/bbgo/pkg/bbgo"
	"github.com/c9s/bbgo/pkg/indicator"
	"github.com/c9s/bbgo/pkg/types"
)

const ID = "getIndStandard"

func init() {
	// Register our struct type to BBGO
	// Note that you don't need to field the fields.
	// BBGO uses reflect to parse your type information.
	bbgo.RegisterStrategy(ID, &amp;Strategy{})
}

type Strategy struct {
	Symbol   string         `json:"symbol"`
	Interval types.Interval `json:"interval"`
	Window   int            `json:"window"`

	// 調用在StandardIndicatorSet裡的指標，還是要用指標本身的struct來接
	SMA *indicator.SMA

	// use this instance that would call indicator
	// by using the symbol defined in the strategy block of yaml file
	StandardIndicatorSet *bbgo.StandardIndicatorSet
}

func (s *Strategy) ID() string {
	return ID
}

// func (s *Strategy) InstanceID() string {
// 	return fmt.Sprintf("%s:%s:%s", ID, s.Symbol, s.Interval)
// }

func (s *Strategy) Subscribe(session *bbgo.ExchangeSession) {
	// session.Subscribe(types.KLineChannel, s.Symbol, types.SubscribeOptions{Interval: s.Interval})

	// 訂閱yaml檔策略區塊裡的symbol K線資料
	session.Subscribe(types.KLineChannel, s.Symbol, types.SubscribeOptions{Interval: "5m"})

}

func (s *Strategy) Run(ctx context.Context, orderExecutor bbgo.OrderExecutor, session *bbgo.ExchangeSession) error {

	// now we call the indicator without symbol
	// but acutally it is using the symbol defined in the strategy block of yaml file
	s.SMA = s.StandardIndicatorSet.SMA(types.IntervalWindow{Interval: s.Interval, Window: s.Window})

	// after initialized, we can use the OnUpdate() method or the Last(i) method of the indicator
	// we don't have to bind of ourselves
	// StandardIndicatorSet have already done it for us
	s.SMA.OnUpdate(func(v float64) {

		fmt.Println("sma value from OnUpdate: ", v, " symbol:", s.StandardIndicatorSet.Symbol)
	})
	session.MarketDataStream.OnKLineClosed(types.KLineWith(s.Symbol, s.Interval, func(k types.KLine) {

		fmt.Println("sma value with Last(0): ", s.SMA.Last(0))

	}))
	return nil
}
</code></pre>
<h3 id="策略yaml檔">策略yaml檔</h3>
<pre><code>exchangeStrategies:
- on: binance
  getIndStandard:
    symbol: BTCUSDT
    interval: 5m
    window: 60
   
backtest:
  startTime: "2023-12-21"
  endTime: "2023-12-22"
  symbols:
  - BTCUSDT
  sessions: [binance]
  # syncSecKLines: true
  accounts:
    binance:
      makerFeeRate: 0.0%
      takerFeeRate: 0.075%
      balances:
        BTC: 0.0
        USDT: 10_000.0
</code></pre>
<blockquote>
<p>Written with <a href="https://stackedit.io/">StackEdit</a>.</p>
</blockquote>
</div>
</body>

</html>
